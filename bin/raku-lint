#!/usr/bin/env raku

use Raku::Lint;

if !@*ARGS {
    say qq:to/HERE/;
    Usage: {$*PROGRAM.basename} [options...] <files to check...>

    Checks files for errors:

      matching =begin/=end blocks
      file opens without a close

    Options:

      --file=X   Files listed in file X are added to the list of files
                   to check.
      --verbose  Reports findings in detail to stdout.
    HERE
    exit;
}

my $verbose = 0;
my %ifils   = SetHash.new;
my $debug   = 0;
my $ifil    = 0;
for @*ARGS -> $arg {
    if !$arg.IO.f  {
        if $arg ~~ /:i ^ '-'? '-d' [ebug]? $/ {
            ++$debug;
        }
        elsif $arg ~~ /:i ^ '-'? '-v' [erbose]? $/ {
            ++$verbose;
        }
        elsif $arg ~~ /:i ^ '--file=' (.+) / {
            $ifil = ~$0;
        }
        else {
            say "FATAL:  Unknown arg '$arg'.";
            exit;
        }
        next;
    }

    # must be a file
    %ifils{$arg}++;

}

my $tifil = 't/data/raku-lint-test-script.raku';
if $debug {
    %ifils{$tifil}++;
}

die "FATAL: No files entered.\n" if !%ifils && !$ifil;

Lint(%ifils, :$ifil, :$debug, :$verbose);
